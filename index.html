<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <button onclick="routerHistory.push('/')">首页</button>
    <button onclick="routerHistory.push('/about')">关于我</button>
    <button onclick="routerHistory.replace('/xxx')">替换</button>
  </body>
  <script>
    // Vue-Router4 -> history.pushState(state, null, url)/replaceState
    // 进行 hash 模式 (pushState(state, null, "#/")) 或 history 模式 (pushState(state, null, "/abc"))
    // 如果没有history -> window.location.hash = "/"

    // 创建一个 state 生成器, 用来生成 state 对象
    // back: 后退的路径;current: 当前的路径;forward: 前进的路径
    // replace: 是否是 replace 跳转的;scroll: 当前滚动条记录;position: 页面位置
    function buildState(
      back,
      current,
      forward,
      replace = false,
      computedScroll = false
    ) {
      return {
        back,
        current,
        forward,
        replace,
        scroll: computedScroll,
        position: window.history.length - 1,
      }
    }

    function createCurrentLocation() {
      const { pathname, search, hash } = window.location
      return pathname + search + hash
    }

    function useHistoryStateNavigation() {
      // 获取当前 url
      const currentLocation = {
        value: createCurrentLocation(),
      }
      // 获取当前 state
      const historyState = {
        value: window.history.state,
      }
      // 第一次刷新页面,没有状态,需要去添加
      if (!historyState.value) {
        changeLocation(
          currentLocation.value,
          buildState(null, currentLocation.value, null, true),
          true
        )
      }

      function changeLocation(to, state, replace) {
        // 跳转并添加状态
        window.history[replace ? 'replaceState' : 'pushState'](state, null, to)
        historyState.value = state
      }

      // data 是 状态
      function push(to, data) {
        // 第一次跳转,原地跳转更新当前状态
        const currentState = Object.assign({}, historyState.value, {
          forward: to,
          scroll: { left: window.pageXOffset, top: window.pageYOffset },
        })
        changeLocation(currentState.current, currentState, true)
        // 第二次跳转,真正跳转更新跳转后的状态
        const state = Object.assign(
          {},
          buildState(currentLocation.value, to, null),
          {
            position: currentState.position + 1,
          },
          data
        )
        changeLocation(to, state, false)
        currentLocation.value = to
      }

      function replace(to, data) {
        // 直接更新 state 和 location
        const state = Object.assign(
          {},
          buildState(
            historyState.value.back,
            to,
            historyState.value.forward,
            true
          ),
          data
        )
        changeLocation(to, state, true)
        currentLocation.value = to
      }

      return {
        location: currentLocation,
        state: historyState,
        push,
        replace,
      }
    }

    function useHistoryListeners(historyState, currentLocation) {
      let listeners = []
      const popStateHandler = ({ state }) => {
        // 获取当前 location
        // 之前 location
        // 之前 state
        const to = createCurrentLocation()
        const from = currentLocation.value
        const fromState = historyState.value

        // 赋值最新的 location 和 state
        currentLocation.value = to
        historyState.value = state

        // 判断是不是 back
        let isBack = state.position - fromState.position < 0

        // 执行用户传入的 cb
        listeners.forEach((listener) => {
          listener(to, from, { isBack })
        })
      }
      window.addEventListener('popstate', popStateHandler)
      function listen(cb) {
        listeners.push(cb)
      }

      return {
        listen,
      }
    }

    // 出口函数,返回提供用户的 API
    function createWebHistory() {
      // 需要返回 当前状态 state | 当前路径 | push 方法 | replace 方法
      const historyNavigation = useHistoryStateNavigation()
      // 监听 前进 后退 函数, 并且修改路径和状态
      const historyListeners = useHistoryListeners(
        historyNavigation.state,
        historyNavigation.location
      )
      // 整合返回的两大对象
      const routerHistory = Object.assign(
        {},
        historyNavigation,
        historyListeners
      )
      // 代理模式改写属性对应的值,方便直接get对应的值
      Object.defineProperty(routerHistory, 'location', {
        get() {
          historyNavigation.location.value
        },
      })
      Object.defineProperty(routerHistory, 'state', {
        get() {
          historyNavigation.state.value
        },
      })
      return routerHistory
    }

    const routerHistory = createWebHistory()

    routerHistory.listen((to, from, { isBack }) => {
      console.log(to, from, isBack)
    })
  </script>
</html>
